SHELL= /bin/bash

# Build 'exprMatrix.tsv'. This will download ~38 GB of sequence data.
all: exprMatrix.tsv

# Use Docker executables.
DOCKER_RUN= docker run --rm -v $$(pwd):/tmp -u$$(id -u):$$(id -g) schiv

# Keep first, plus every even column.
AWKSCRIPT= '{ printf "%s%s", $$1, OFS; for(i=2; i<=NF; i+=2) printf "%s%s", $$i, (i>=NF?"\n":OFS) }'

gencode.v38.pc_transcripts.fa.gz:
	$(DOCKER_RUN) wget http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_38/gencode.v38.pc_transcripts.fa.gz

GRCh38.p13.genome.fa.gz:
	$(DOCKER_RUN) wget http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_38/GRCh38.p13.genome.fa.gz

decoys.txt: GRCh38.p13.genome.fa.gz
	$(DOCKER_RUN) zcat GRCh38.p13.genome.fa.gz | grep "^>" | cut -d" " -f1 | sed "s/^>//" > decoys.txt

# HIVmini.fa.gz is the sequence of the miniconstruct as we know it.
gentrome.fa.gz: gencode.v38.pc_transcripts.fa.gz HIVmini.fa.gz GRCh38.p13.genome.fa.gz
	$(DOCKER_RUN) true && cat gencode.v38.pc_transcripts.fa.gz HIVmini.fa.gz GRCh38.p13.genome.fa.gz > gentrome.fa.gz

gencode.v38+HIV.idx: gentrome.fa.gz decoys.txt
	$(DOCKER_RUN) salmon index -p8 -t gentrome.fa.gz -d decoys.txt -i gencode.v38+HIV.idx --gencode

%.quant: %_1.fastq.gz %_2.fastq.gz gencode.v38+HIV.idx gencode.v38.pc_transcripts.fa.gz
	$(DOCKER_RUN) salmon quant -p4 -i gencode.v38+HIV.idx -lA -1 $*_1.fastq.gz -2 $*_2.fastq.gz --validateMappings -o tmp-$*
	$(DOCKER_RUN) scripts/tx2gene.py gencode.v38.pc_transcripts.fa.gz tmp-$*/quant.sf > $@ && rm -r tmp-$*

.SECONDEXPANSION:
exprMatrix.tsv: $$(QUANT)
	$(DOCKER_RUN) echo "$^" | sed -e "s/.quant//g" -e "s/[[:space:]]/\t/g" > $@
	$(DOCKER_RUN) paste -d" " $^ | awk -v OFS="\t" $(AWKSCRIPT) >> $@

remove_intermediates:
	rm -rf *.quant gentrome.fa.gz

QUANT=	P2449_N716-S502.quant \
	P2449_N716-S503.quant \
	P2449_N716-S505.quant \
	P2449_N716-S506.quant \
	P2449_N716-S507.quant \
	P2449_N716-S508.quant \
	P2449_N716-S510.quant \
	P2449_N716-S511.quant \
	P2449_N718-S502.quant \
	P2449_N718-S503.quant \
	P2449_N718-S505.quant \
	P2449_N718-S506.quant \
	P2449_N718-S507.quant \
	P2449_N718-S508.quant \
	P2449_N718-S510.quant \
	P2449_N718-S511.quant \
	P2449_N719-S502.quant \
	P2449_N719-S503.quant \
	P2449_N719-S505.quant \
	P2449_N719-S506.quant \
	P2449_N719-S507.quant \
	P2449_N719-S508.quant \
	P2449_N719-S510.quant \
	P2449_N719-S511.quant \
	P2449_N720-S502.quant \
	P2449_N720-S503.quant \
	P2449_N720-S505.quant \
	P2449_N720-S506.quant \
	P2449_N720-S507.quant \
	P2449_N720-S508.quant \
	P2449_N720-S510.quant \
	P2449_N720-S511.quant \
	P2449_N721-S502.quant \
	P2449_N721-S503.quant \
	P2449_N721-S505.quant \
	P2449_N721-S506.quant \
	P2449_N721-S507.quant \
	P2449_N721-S508.quant \
	P2449_N721-S510.quant \
	P2449_N721-S511.quant \
	P2449_N722-S502.quant \
	P2449_N722-S503.quant \
	P2449_N722-S505.quant \
	P2449_N722-S506.quant \
	P2449_N722-S507.quant \
	P2449_N722-S508.quant \
	P2449_N722-S510.quant \
	P2449_N722-S511.quant \
	P2449_N723-S502.quant \
	P2449_N723-S503.quant \
	P2449_N723-S505.quant \
	P2449_N723-S506.quant \
	P2449_N723-S507.quant \
	P2449_N723-S508.quant \
	P2449_N723-S510.quant \
	P2449_N723-S511.quant \
	P2449_N724-S502.quant \
	P2449_N724-S503.quant \
	P2449_N724-S505.quant \
	P2449_N724-S506.quant \
	P2449_N724-S507.quant \
	P2449_N724-S508.quant \
	P2449_N724-S510.quant \
	P2449_N724-S511.quant \
	P2449_N726-S502.quant \
	P2449_N726-S503.quant \
	P2449_N726-S505.quant \
	P2449_N726-S506.quant \
	P2449_N726-S507.quant \
	P2449_N726-S508.quant \
	P2449_N726-S510.quant \
	P2449_N726-S511.quant \
	P2449_N727-S502.quant \
	P2449_N727-S503.quant \
	P2449_N727-S505.quant \
	P2449_N727-S506.quant \
	P2449_N727-S507.quant \
	P2449_N727-S508.quant \
	P2449_N727-S510.quant \
	P2449_N727-S511.quant \
	P2449_N728-S502.quant \
	P2449_N728-S503.quant \
	P2449_N728-S505.quant \
	P2449_N728-S506.quant \
	P2449_N728-S507.quant \
	P2449_N728-S508.quant \
	P2449_N728-S510.quant \
	P2449_N728-S511.quant \
	P2449_N729-S502.quant \
	P2449_N729-S503.quant \
	P2449_N729-S505.quant \
	P2449_N729-S506.quant \
	P2449_N729-S507.quant \
	P2449_N729-S508.quant \
	P2449_N729-S510.quant \
	P2449_N729-S511.quant \
	P2458_N701-S513.quant \
	P2458_N701-S515.quant \
	P2458_N701-S516.quant \
	P2458_N701-S517.quant \
	P2458_N701-S518.quant \
	P2458_N701-S520.quant \
	P2458_N701-S521.quant \
	P2458_N701-S522.quant \
	P2458_N702-S513.quant \
	P2458_N702-S515.quant \
	P2458_N702-S516.quant \
	P2458_N702-S517.quant \
	P2458_N702-S518.quant \
	P2458_N702-S520.quant \
	P2458_N702-S521.quant \
	P2458_N702-S522.quant \
	P2458_N703-S513.quant \
	P2458_N703-S515.quant \
	P2458_N703-S516.quant \
	P2458_N703-S517.quant \
	P2458_N703-S518.quant \
	P2458_N703-S520.quant \
	P2458_N703-S521.quant \
	P2458_N703-S522.quant \
	P2458_N704-S513.quant \
	P2458_N704-S515.quant \
	P2458_N704-S516.quant \
	P2458_N704-S517.quant \
	P2458_N704-S518.quant \
	P2458_N704-S520.quant \
	P2458_N704-S521.quant \
	P2458_N704-S522.quant \
	P2458_N705-S513.quant \
	P2458_N705-S515.quant \
	P2458_N705-S516.quant \
	P2458_N705-S517.quant \
	P2458_N705-S518.quant \
	P2458_N705-S520.quant \
	P2458_N705-S521.quant \
	P2458_N705-S522.quant \
	P2458_N706-S513.quant \
	P2458_N706-S515.quant \
	P2458_N706-S516.quant \
	P2458_N706-S517.quant \
	P2458_N706-S518.quant \
	P2458_N706-S520.quant \
	P2458_N706-S521.quant \
	P2458_N706-S522.quant \
	P2458_N707-S513.quant \
	P2458_N707-S515.quant \
	P2458_N707-S516.quant \
	P2458_N707-S517.quant \
	P2458_N707-S518.quant \
	P2458_N707-S520.quant \
	P2458_N707-S521.quant \
	P2458_N707-S522.quant \
	P2458_N710-S513.quant \
	P2458_N710-S515.quant \
	P2458_N710-S516.quant \
	P2458_N710-S517.quant \
	P2458_N710-S518.quant \
	P2458_N710-S520.quant \
	P2458_N710-S521.quant \
	P2458_N710-S522.quant \
	P2458_N711-S513.quant \
	P2458_N711-S515.quant \
	P2458_N711-S516.quant \
	P2458_N711-S517.quant \
	P2458_N711-S518.quant \
	P2458_N711-S520.quant \
	P2458_N711-S521.quant \
	P2458_N711-S522.quant \
	P2458_N712-S513.quant \
	P2458_N712-S515.quant \
	P2458_N712-S516.quant \
	P2458_N712-S517.quant \
	P2458_N712-S518.quant \
	P2458_N712-S520.quant \
	P2458_N712-S521.quant \
	P2458_N712-S522.quant \
	P2458_N714-S513.quant \
	P2458_N714-S515.quant \
	P2458_N714-S516.quant \
	P2458_N714-S517.quant \
	P2458_N714-S518.quant \
	P2458_N714-S520.quant \
	P2458_N714-S521.quant \
	P2458_N714-S522.quant \
	P2458_N715-S513.quant \
	P2458_N715-S515.quant \
	P2458_N715-S516.quant \
	P2458_N715-S517.quant \
	P2458_N715-S518.quant \
	P2458_N715-S520.quant \
	P2458_N715-S521.quant \
	P2458_N715-S522.quant \
	P2769_N701-S502.quant \
	P2769_N701-S503.quant \
	P2769_N701-S505.quant \
	P2769_N701-S506.quant \
	P2769_N701-S507.quant \
	P2769_N701-S508.quant \
	P2769_N701-S510.quant \
	P2769_N701-S511.quant \
	P2769_N702-S502.quant \
	P2769_N702-S503.quant \
	P2769_N702-S505.quant \
	P2769_N702-S506.quant \
	P2769_N702-S507.quant \
	P2769_N702-S508.quant \
	P2769_N702-S510.quant \
	P2769_N702-S511.quant \
	P2769_N703-S502.quant \
	P2769_N703-S503.quant \
	P2769_N703-S505.quant \
	P2769_N703-S506.quant \
	P2769_N703-S507.quant \
	P2769_N703-S508.quant \
	P2769_N703-S510.quant \
	P2769_N703-S511.quant \
	P2769_N704-S502.quant \
	P2769_N704-S503.quant \
	P2769_N704-S505.quant \
	P2769_N704-S506.quant \
	P2769_N704-S507.quant \
	P2769_N704-S508.quant \
	P2769_N704-S510.quant \
	P2769_N704-S511.quant \
	P2769_N705-S502.quant \
	P2769_N705-S503.quant \
	P2769_N705-S505.quant \
	P2769_N705-S506.quant \
	P2769_N705-S507.quant \
	P2769_N705-S508.quant \
	P2769_N705-S510.quant \
	P2769_N705-S511.quant \
	P2769_N706-S502.quant \
	P2769_N706-S503.quant \
	P2769_N706-S505.quant \
	P2769_N706-S506.quant \
	P2769_N706-S507.quant \
	P2769_N706-S508.quant \
	P2769_N706-S510.quant \
	P2769_N706-S511.quant \
	P2769_N707-S502.quant \
	P2769_N707-S503.quant \
	P2769_N707-S505.quant \
	P2769_N707-S506.quant \
	P2769_N707-S507.quant \
	P2769_N707-S508.quant \
	P2769_N707-S510.quant \
	P2769_N707-S511.quant \
	P2769_N710-S502.quant \
	P2769_N710-S503.quant \
	P2769_N710-S505.quant \
	P2769_N710-S506.quant \
	P2769_N710-S507.quant \
	P2769_N710-S508.quant \
	P2769_N710-S510.quant \
	P2769_N710-S511.quant \
	P2769_N711-S502.quant \
	P2769_N711-S503.quant \
	P2769_N711-S505.quant \
	P2769_N711-S506.quant \
	P2769_N711-S507.quant \
	P2769_N711-S508.quant \
	P2769_N711-S510.quant \
	P2769_N711-S511.quant \
	P2769_N712-S502.quant \
	P2769_N712-S503.quant \
	P2769_N712-S505.quant \
	P2769_N712-S506.quant \
	P2769_N712-S507.quant \
	P2769_N712-S508.quant \
	P2769_N712-S510.quant \
	P2769_N712-S511.quant \
	P2769_N714-S502.quant \
	P2769_N714-S503.quant \
	P2769_N714-S505.quant \
	P2769_N714-S506.quant \
	P2769_N714-S507.quant \
	P2769_N714-S508.quant \
	P2769_N714-S510.quant \
	P2769_N714-S511.quant \
	P2769_N715-S502.quant \
	P2769_N715-S503.quant \
	P2769_N715-S505.quant \
	P2769_N715-S506.quant \
	P2769_N715-S507.quant \
	P2769_N715-S508.quant \
	P2769_N715-S510.quant \
	P2769_N715-S511.quant \
	P2770_N701-S513.quant \
	P2770_N701-S515.quant \
	P2770_N701-S516.quant \
	P2770_N701-S517.quant \
	P2770_N701-S518.quant \
	P2770_N701-S520.quant \
	P2770_N701-S521.quant \
	P2770_N701-S522.quant \
	P2770_N702-S513.quant \
	P2770_N702-S515.quant \
	P2770_N702-S516.quant \
	P2770_N702-S517.quant \
	P2770_N702-S518.quant \
	P2770_N702-S520.quant \
	P2770_N702-S521.quant \
	P2770_N702-S522.quant \
	P2770_N703-S513.quant \
	P2770_N703-S515.quant \
	P2770_N703-S516.quant \
	P2770_N703-S517.quant \
	P2770_N703-S518.quant \
	P2770_N703-S520.quant \
	P2770_N703-S521.quant \
	P2770_N703-S522.quant \
	P2770_N704-S513.quant \
	P2770_N704-S515.quant \
	P2770_N704-S516.quant \
	P2770_N704-S517.quant \
	P2770_N704-S518.quant \
	P2770_N704-S520.quant \
	P2770_N704-S521.quant \
	P2770_N704-S522.quant \
	P2770_N705-S513.quant \
	P2770_N705-S515.quant \
	P2770_N705-S516.quant \
	P2770_N705-S517.quant \
	P2770_N705-S518.quant \
	P2770_N705-S520.quant \
	P2770_N705-S521.quant \
	P2770_N705-S522.quant \
	P2770_N706-S513.quant \
	P2770_N706-S515.quant \
	P2770_N706-S516.quant \
	P2770_N706-S517.quant \
	P2770_N706-S518.quant \
	P2770_N706-S520.quant \
	P2770_N706-S521.quant \
	P2770_N706-S522.quant \
	P2770_N707-S513.quant \
	P2770_N707-S515.quant \
	P2770_N707-S516.quant \
	P2770_N707-S517.quant \
	P2770_N707-S518.quant \
	P2770_N707-S520.quant \
	P2770_N707-S521.quant \
	P2770_N707-S522.quant \
	P2770_N710-S513.quant \
	P2770_N710-S515.quant \
	P2770_N710-S516.quant \
	P2770_N710-S517.quant \
	P2770_N710-S518.quant \
	P2770_N710-S520.quant \
	P2770_N710-S521.quant \
	P2770_N710-S522.quant \
	P2770_N711-S513.quant \
	P2770_N711-S515.quant \
	P2770_N711-S516.quant \
	P2770_N711-S517.quant \
	P2770_N711-S518.quant \
	P2770_N711-S520.quant \
	P2770_N711-S521.quant \
	P2770_N711-S522.quant \
	P2770_N712-S513.quant \
	P2770_N712-S515.quant \
	P2770_N712-S516.quant \
	P2770_N712-S517.quant \
	P2770_N712-S518.quant \
	P2770_N712-S520.quant \
	P2770_N712-S521.quant \
	P2770_N712-S522.quant \
	P2770_N714-S513.quant \
	P2770_N714-S515.quant \
	P2770_N714-S516.quant \
	P2770_N714-S517.quant \
	P2770_N714-S518.quant \
	P2770_N714-S520.quant \
	P2770_N714-S521.quant \
	P2770_N714-S522.quant \
	P2770_N715-S513.quant \
	P2770_N715-S515.quant \
	P2770_N715-S516.quant \
	P2770_N715-S517.quant \
	P2770_N715-S518.quant \
	P2770_N715-S520.quant \
	P2770_N715-S521.quant \
	P2770_N715-S522.quant \
	P2771_N701-S502.quant \
	P2771_N701-S503.quant \
	P2771_N701-S505.quant \
	P2771_N701-S506.quant \
	P2771_N701-S507.quant \
	P2771_N701-S508.quant \
	P2771_N701-S510.quant \
	P2771_N701-S511.quant \
	P2771_N702-S502.quant \
	P2771_N702-S503.quant \
	P2771_N702-S505.quant \
	P2771_N702-S506.quant \
	P2771_N702-S507.quant \
	P2771_N702-S508.quant \
	P2771_N702-S510.quant \
	P2771_N702-S511.quant \
	P2771_N703-S502.quant \
	P2771_N703-S503.quant \
	P2771_N703-S505.quant \
	P2771_N703-S506.quant \
	P2771_N703-S507.quant \
	P2771_N703-S508.quant \
	P2771_N703-S510.quant \
	P2771_N703-S511.quant \
	P2771_N704-S502.quant \
	P2771_N704-S503.quant \
	P2771_N704-S505.quant \
	P2771_N704-S506.quant \
	P2771_N704-S507.quant \
	P2771_N704-S508.quant \
	P2771_N704-S510.quant \
	P2771_N704-S511.quant \
	P2771_N705-S502.quant \
	P2771_N705-S503.quant \
	P2771_N705-S505.quant \
	P2771_N705-S506.quant \
	P2771_N705-S507.quant \
	P2771_N705-S508.quant \
	P2771_N705-S510.quant \
	P2771_N705-S511.quant \
	P2771_N706-S502.quant \
	P2771_N706-S503.quant \
	P2771_N706-S505.quant \
	P2771_N706-S506.quant \
	P2771_N706-S507.quant \
	P2771_N706-S508.quant \
	P2771_N706-S510.quant \
	P2771_N706-S511.quant \
	P2771_N707-S502.quant \
	P2771_N707-S503.quant \
	P2771_N707-S505.quant \
	P2771_N707-S506.quant \
	P2771_N707-S507.quant \
	P2771_N707-S508.quant \
	P2771_N707-S510.quant \
	P2771_N707-S511.quant \
	P2771_N710-S502.quant \
	P2771_N710-S503.quant \
	P2771_N710-S505.quant \
	P2771_N710-S506.quant \
	P2771_N710-S507.quant \
	P2771_N710-S508.quant \
	P2771_N710-S510.quant \
	P2771_N710-S511.quant \
	P2771_N711-S502.quant \
	P2771_N711-S503.quant \
	P2771_N711-S505.quant \
	P2771_N711-S506.quant \
	P2771_N711-S507.quant \
	P2771_N711-S508.quant \
	P2771_N711-S510.quant \
	P2771_N711-S511.quant \
	P2771_N712-S502.quant \
	P2771_N712-S503.quant \
	P2771_N712-S505.quant \
	P2771_N712-S506.quant \
	P2771_N712-S507.quant \
	P2771_N712-S508.quant \
	P2771_N712-S510.quant \
	P2771_N712-S511.quant \
	P2771_N714-S502.quant \
	P2771_N714-S503.quant \
	P2771_N714-S505.quant \
	P2771_N714-S506.quant \
	P2771_N714-S507.quant \
	P2771_N714-S508.quant \
	P2771_N714-S510.quant \
	P2771_N714-S511.quant \
	P2771_N715-S502.quant \
	P2771_N715-S503.quant \
	P2771_N715-S505.quant \
	P2771_N715-S506.quant \
	P2771_N715-S507.quant \
	P2771_N715-S508.quant \
	P2771_N715-S510.quant \
	P2771_N715-S511.quant
